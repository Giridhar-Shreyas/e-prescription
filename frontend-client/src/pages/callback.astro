---
// src/pages/callback.astro
import Layout from '../layouts/Layout.astro';
---

<Layout title="Login Callback">
  <div class="loading-container">
    <div class="spinner"></div>
    <p>Completing login...</p>
  </div>
</Layout>

<script>
  import { getToken } from '../lib/keycloak-auth.js';
  
  // Get the authorization code from URL
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  
  if (code) {
    // Exchange code for tokens
    getToken(code)
      .then(tokens => {
        // Save tokens
        localStorage.setItem('access_token', tokens.access_token);
        localStorage.setItem('refresh_token', tokens.refresh_token);
        
        // Redirect to dashboard
        window.location.href = '/dashboard';
      })
      .catch(error => {
        console.error('Login failed:', error);
        alert('Login failed. Please try again.');
        window.location.href = '/';
      });
  } else {
    // No code, redirect to home
    window.location.href = '/';
  }
</script>

<style>
  .loading-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  p {
    font-size: 1.2rem;
  }
</style>